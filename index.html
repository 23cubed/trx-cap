<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <title>Particle Image Filter Demo</title>
  <style>
    html,body{height:100%;}
    body{margin:0;display:flex;align-items:center;justify-content:center;background:#0b0f14;color:#fff;font-family:system-ui, -apple-system, Segoe UI, Roboto, sans-serif;}
    .stage{position:relative;display:inline-block;}
    img.particle-image{display:block;width:min(80vw, 80vh);height:auto;}
    /* The script overlays a canvas on the parent of the image */
  </style>
</head>
<body>
  <div class="stage">
    <img class="particle-image" src="./src/assets/spacex-VBNb52J8Trk-unsplash.jpg" alt="Demo" style="opacity:0;" />
  </div>

  <script>
  (function(){
    var __debug=true;function log(){if(!__debug)return;try{console.log.apply(console,arguments);}catch(e){}}
    function ensureThree(){return new Promise(function(resolve,reject){if(window.THREE){log('[particles] THREE already present');resolve();return;}var s=document.createElement('script');s.src='https://unpkg.com/three@0.152.2/build/three.min.js';s.async=true;s.onload=function(){log('[particles] THREE loaded');resolve();};s.onerror=function(){reject(new Error('Failed to load three.js'));};document.head.appendChild(s);});}
    function waitForImage(img){return new Promise(function(resolve){if(img.complete&&img.naturalWidth>0){log('[particles] image ready',img.naturalWidth,img.naturalHeight);resolve();return;}img.addEventListener('load',function(){log('[particles] image load event',img.naturalWidth,img.naturalHeight);resolve();},{once:true});});}
    function applyParticleEffect(img,opts){var spacing=(opts&&opts.spacing)||2;var pointSize=(opts&&opts.pointSize)||2;var parent=img.parentElement;if(!parent){log('[particles] no parent for image');return;}var cs=window.getComputedStyle(parent);if(cs.position==='static'){parent.style.position='relative';}
      var canvas=document.createElement('canvas');canvas.style.position='absolute';canvas.style.inset='0';canvas.style.width='100%';canvas.style.height='100%';canvas.style.pointerEvents='none';canvas.style.zIndex='10';parent.appendChild(canvas);
      canvas.addEventListener('webglcontextlost',function(e){log('[particles] webgl context lost');},false);
      canvas.addEventListener('webglcontextrestored',function(){log('[particles] webgl context restored');},false);
      img.style.visibility='hidden';
      var renderer=new window.THREE.WebGLRenderer({canvas:canvas,antialias:true,alpha:true,preserveDrawingBuffer:false});
      var pr=Math.min(2,window.devicePixelRatio||1);renderer.setPixelRatio(pr);log('[particles] pixelRatio',pr);
      var mouse={x:0,y:0};var onMove=function(e){mouse.x=e.clientX;mouse.y=e.clientY;};window.addEventListener('mousemove',onMove);
      function getCanvasMousePosition(){var r=canvas.getBoundingClientRect();var cx=mouse.x - r.left;var cy=mouse.y - r.top;return {x: cx - canvas.clientWidth/2, y: -(cy - canvas.clientHeight/2)};}
      function buildScene(){var w=img.clientWidth;var h=img.clientHeight;var rect=parent.getBoundingClientRect();log('[particles] buildScene size',w,h,'dpr',window.devicePixelRatio||1,'rect',rect.left,rect.top,rect.width,rect.height);if(w<2||h<2){log('[particles] too small, skipping');return null;}renderer.setSize(w,h,false);log('[particles] renderer size',renderer.domElement.width,renderer.domElement.height);var scene=new window.THREE.Scene();var camera=new window.THREE.OrthographicCamera(-w/2,w/2,h/2,-h/2,1,1000);camera.position.z=10;renderer.setClearColor(0x000000,0);
        var stepDev=Math.max(1,Math.round(spacing*pr));
        var gridWDev=Math.max(1,Math.floor((w*pr)/stepDev));
        var gridHDev=Math.max(1,Math.floor((h*pr)/stepDev));
        log('[particles] device steps', {stepDev:stepDev, gridWDev:gridWDev, gridHDev:gridHDev});
        var tempCanvas=document.createElement('canvas');tempCanvas.width=gridWDev;tempCanvas.height=gridHDev;var tctx=tempCanvas.getContext('2d',{willReadFrequently:true});try{tctx.imageSmoothingEnabled=true;tctx.imageSmoothingQuality='high';}catch(e){}tctx.drawImage(img,0,0,gridWDev,gridHDev);
        var data=tctx.getImageData(0,0,gridWDev,gridHDev).data;log('[particles] pixels',data.length);
        var positions=[];var colors=[];var opacities=[];
        for(var y=0;y<gridHDev;y++){
          for(var x=0;x<gridWDev;x++){
            var idx=(y*gridWDev+x)*4;var r=data[idx]/255;var g=data[idx+1]/255;var b=data[idx+2]/255;
            var devX = x*stepDev + stepDev*0.5 - (w*pr)/2;
            var devY = y*stepDev + stepDev*0.5 - (h*pr)/2;
            var wx = devX / pr; var wy = -devY / pr;
            positions.push(wx,wy,0);colors.push(r,g,b);opacities.push(1);
          }
        }
        if(positions.length===0){log('[particles] no particles generated');return null;}
        var pc=positions.length/3;log('[particles] particle count',pc);
        var geometry=new window.THREE.BufferGeometry();geometry.setAttribute('position',new window.THREE.Float32BufferAttribute(new Float32Array(positions),3));
        geometry.setAttribute('color',new window.THREE.Float32BufferAttribute(new Float32Array(colors),3));
        geometry.setAttribute('opacity',new window.THREE.Float32BufferAttribute(new Float32Array(opacities),1));
        var dotSizeDev=2; // 2 device px for stronger visibility
        var vShader='attribute float opacity;varying float vOpacity;varying vec3 vColor;uniform float uPointSizeDev;void main(){vOpacity=opacity;vColor=color;vec4 mvPosition=modelViewMatrix*vec4(position,1.0);gl_Position=projectionMatrix*mvPosition;gl_PointSize=uPointSizeDev;}';
        var fShader='uniform float uBrightness;uniform float uContrast;varying float vOpacity;varying vec3 vColor;vec3 adjustBC(vec3 c,float b,float k){c=clamp((c-0.5)*k+0.5,0.0,1.0);c=clamp(c*b,0.0,1.0);return c;}void main(){vec3 c=adjustBC(vColor,uBrightness,uContrast);gl_FragColor=vec4(c,1.0);}';
        var material=new window.THREE.ShaderMaterial({uniforms:{uPointSizeDev:{value:dotSizeDev},uBrightness:{value:1.25},uContrast:{value:1.10}},vertexShader:vShader,fragmentShader:fShader,transparent:false,depthWrite:false,depthTest:false,vertexColors:true,blending:window.THREE.NoBlending});
        var points=new window.THREE.Points(geometry,material);points.frustumCulled=false;scene.add(points);log('[particles] dotSizeDev', dotSizeDev, 'stepDev', stepDev, 'grid', gridWDev+'x'+gridHDev);
        var basePositions=new Float32Array(positions);var repulsionOffsets=new Float32Array(positions.length);
        var gridStepWorld = stepDev / pr; // world units per cell
        return {scene:scene,camera:camera,points:points,basePositions:basePositions,repulsionOffsets:repulsionOffsets,gridStepWorld:gridStepWorld};
      }
      var current=null;
      function startLoop(){
        if(!current)return;
        var holeRadius=10; // empty area radius
        var feather=8;     // soft edge width
        var easeSpeed=0.12;
        renderer.setAnimationLoop(function(){
          var positionAttribute=current.points.geometry.getAttribute('position');
          var arr=positionAttribute.array;var mouseW=getCanvasMousePosition();
          for(var i=0;i<positionAttribute.count;i++){
            var bx=current.basePositions[3*i];var by=current.basePositions[3*i+1];var bz=current.basePositions[3*i+2];
            var dx=bx - mouseW.x;var dy=by - mouseW.y;var dist=Math.hypot(dx,dy);
            var targetX=0,targetY=0;
            if(dist>0.0001){
              var nx=dx/dist;var ny=dy/dist;
              if(dist < holeRadius){
                var needed = holeRadius - dist; // push to boundary
                targetX = nx * needed;
                targetY = ny * needed;
              } else if(dist < holeRadius + feather){
                var t = 1.0 - (dist - holeRadius) / feather; // 1â†’0 across feather ring
                var influence = t*t;
                var strength = 1.0; // subtle push
                targetX = nx * influence * strength;
                targetY = ny * influence * strength;
              }
            }
            var offIndex=3*i;
            current.repulsionOffsets[offIndex]+= (targetX - current.repulsionOffsets[offIndex]) * easeSpeed;
            current.repulsionOffsets[offIndex+1]+= (targetY - current.repulsionOffsets[offIndex+1]) * easeSpeed;
            arr[offIndex]=bx + current.repulsionOffsets[offIndex];
            arr[offIndex+1]=by + current.repulsionOffsets[offIndex+1];
            arr[offIndex+2]=bz;
          }
          positionAttribute.needsUpdate=true;renderer.render(current.scene,current.camera);
        });
      }
      function renderOnce(){if(!current)return;renderer.info.autoReset=false;renderer.render(current.scene,current.camera);try{var info=renderer.info;log('[particles] render info', {calls:info.render.calls, points:info.render.points, lines:info.render.lines, triangles:info.render.triangles});}catch(e){}}
      function rebuild(){try{if(current&&current.points){if(current.points.geometry)current.points.geometry.dispose();if(current.points.material)current.points.material.dispose();}}
        catch(e){log('[particles] dispose error',e);} current=buildScene();if(!current){log('[particles] build failed; restoring image');img.style.visibility='';try{canvas.remove();}catch(e){}return;}startLoop();}
      var ro=new ResizeObserver(function(){rebuild();});ro.observe(img);
      rebuild();
      return {dispose:function(){ro.disconnect();window.removeEventListener('mousemove',onMove);if(current&&current.points){if(current.points.geometry)current.points.geometry.dispose();if(current.points.material)current.points.material.dispose();}renderer.setAnimationLoop(null);try{if(renderer.forceContextLoss)renderer.forceContextLoss();}catch(e){}renderer.dispose();canvas.remove();img.style.visibility='';}};
    }
    function init(){var imgs=Array.prototype.slice.call(document.querySelectorAll('img.particle-image'));imgs.forEach(function(img){waitForImage(img).then(function(){applyParticleEffect(img,{spacing:2,pointSize:3});});});}
    if(document.readyState==='loading'){document.addEventListener('DOMContentLoaded',function(){ensureThree().then(init).catch(function(){});});}else{ensureThree().then(init).catch(function(){});} 
  })();
  </script>
</body>
</html>

